---
title: "Spatial Distribution of Taxi Tipping, NYC"
author: "Team Bravo"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, output_format="github_document", output_file="README.md");
  rmarkdown::render(inputFile, output_format="html_document", 
  output_file=paste(substr(inputFile,1,nchar(inputFile)-4),'.html', sep=""))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The question we wish to answer is **whether different New York City neighborhoods differ significantly from each other in tipping percentage.** To answer this question, we computed and compared the average tipping percentages on different pick-up locations and see how the tip amount varies by time. Our dataset exists on Kaggle as the New York Yellow Taxi dataset, but we sourced it directly from GitHub, where we found additional months of data. The data contain a file for each month with pick-up and drop-off times, pick-up and drop-off locations, fare amount and tip amount. Our shell script downloads the data separately by month, wrote a .sub file to clean and process the data in parallel on the CHTC, with each node given a month of data, and finished by writing an .Rmd file to finish our analysis and create our visualizations. We ran two separate analysis for the two boroughs we focused our efforts on: Manhattan and Brooklyn. We found little variation in tipping percentage by neighborhood over time, however we did find convincing evidence for differences in tipping percentage density between local neighborhoods within each borough.

## Data Description / Manipulation

The dataset contains information on every taxi trip to occur in New York City between 2005 and 2021. The data are contained in a different csv for each month within that time frame. Early on, we ran into issues with downloading all of the data as one big file, so we found another website with the same data as well as more data for other years. For our spatial analysis, our computation was initially going to rely on the exact latitude and longitude of a tripâ€™s pick-up or drop-off point. Through a bit of data observation, we found that files from later years did not contain this information, and that we would have had to bin these coordinates into neighborhoods, a challenging task. Luckily, for all years after 2017, the data files contained a different variable, `LocationID`, which categorized the location into different neighborhoods. Due to latitude and longitude shape files being difficult to work with, we took the ID value to simplify our computation, joining it with another dataset of NYC neighborhood shape files, which were compatible with our data. This is how we were able to graph our tipping and frequency values on a map. 

## Manhattan

## Visual Analysis

Our analysis consisted of a spatial density analysis over time. As shown in the graph on the right, we graphed tipping percentage concentrations within neighborhoods on Manhattan. The darker the shade of green within each shape, the higher the average percentage of ride cost that was tipped within that geometry and month (missing values are colored red). We see a higher density of tipping percentages as we move south through Manhattan. We also see tip density increase in magnitude over the time frame of the animation.
<br/><br/>

```{r, echo=FALSE, out.width="70%", fig.cap="\\textcolor{red}{Higher tipping percentages on wealtier regions}", fig.align = 'center'}
knitr::include_graphics("C:/Users/17083/OneDrive/Documents/stat479/final/imgs/avgtips.gif")
```

<br/><br/>
Although the animation above shows little variability in tipping percentages over time within neighborhoods, we can see a slight favoring of southern Manhattan regions. Battery Park City and Hudson Square, along with West Village and Union Square boast the highest tipping percentages averaged over our time frame. These neighborhoods are all located near the Financial District, in wealthier neighborhoods. Harlem and other northern Manhattan neighborhoods boast lower tipping percentages. These neighborhoods are also far less attractive to wealthier riders, which we posit to be the most influential factor in our analysis. 

## Statistical Analysis

After we identified visual differences between neighborhood locales, we looked into empirical analysis of them. Our idea here was to assess whether neighborhood had an empirically verifiable effect on tipping percentage, isolated at each specific month of data. Thus, a Repeated Measures ANOVA was run on average tips by date and location for the full dataset. This methodology was used in order to determine how much variance in tipping could be explained by pickup neighborhood while controlling for the temporal dimension of our data. The effect of neighborhood on average tips was highly significant (p=6.05e-17) within each date point (months), giving us ample evidence to conclude that there is some dependency between location and tipping. Battery Park City and Hudson Square, along with West Village, meatpacking district and Union Square boast the highest tipping percentages averaged over our time frame. These neighborhoods are all located near the Financial District, in wealthier neighborhoods. Northern Manhattan neighborhoods like Harlem & Inwood boast lower tipping percentages. More on these differences below.


<br/><br/>

```{r, echo=FALSE, out.width="70%", fig.cap="\\textcolor{red}{Higher tipping percentages on wealtier regions}", fig.show="hold", out.width="50%"}
knitr::include_graphics("C:/Users/17083/OneDrive/Documents/stat479/final/imgs/ratediffs.png")
knitr::include_graphics("C:/Users/17083/OneDrive/Documents/stat479/final/imgs/hood_map.png")
```

<br/><br/>

## Brooklyn

Our visual and statistical analyses for Brooklyn neighborhood tipping differences followed a very similar pattern to our analysis of Manhattan. We began by re-filtering the data so that we were focusing solely on data for the Brooklyn borough. Then we created a gif of this specific data subset over time, as well as an analysis of the five highest and lowest average tippers.

<br/><br/>

```{r, echo=FALSE, out.width="70%", fig.cap="\\textcolor{red}{Higher tipping percentages on wealtier regions}", fig.align = 'center'}
knitr::include_graphics("C:/Users/17083/OneDrive/Documents/stat479/final/imgs/avgtips_brooklyn.gif")
```

<br/><br/>

<br/><br/>

```{r, echo=FALSE, out.width="70%", fig.cap="\\textcolor{red}{Higher tipping percentages on wealtier regions}", fig.show="hold", out.width="50%"}
knitr::include_graphics("C:/Users/17083/OneDrive/Documents/stat479/final/imgs/ratediffs_brooklyn.png")
knitr::include_graphics("C:/Users/17083/OneDrive/Documents/stat479/final/imgs/hood_map_brooklyn.png")
```

<br/><br/>

The animation shows a lot more variability over time than the Manhattan animation shows. This could be due to a lower population, and thus a lower cab ride frequency, within this borough as compared with Manhattan.However, we do see a noticeable density trend, just like we saw for Manhattan. And, what do you know, it's the wealthier areas like Brooklyn Heights (Northwest) that are generally tipping higher percentages. The statistical analysis for this borough returned similar results to that of the Manhattan analysis, we ran another RMANOVA to test differences between neighborhoods when controlling for time. The result was highly significant(p=9.07e-40), lending us evidence that neighborhood and tipping percentage are not independent of each other.

## Conclusion

We think that that tipping is strongly influenced by both social expectations and disposable income; riders in richer neighborhoods are both expected to and more able to consistently tip better than those in less affluent neighborhoods. This idea is backed up by the general invariability of tipping percentages within geometries over time, with the same neighborhoods holding relatively constant in terms of tipping percentage density. Another point of interest depicted by this map is the invariability of tipping percentages within geometries over time. This is further evidence for our hypothesis that tipping is strongly influenced by both social expectations and disposable income; riders in richer neighborhoods are both expected to and more able to consistently tip better than those in less affluent neighborhoods. Finally, we want to take the time to address the fact that this information, if presented to an actual client, might have adverse social consequences for potential passengers in the neighborhoods identified by us as lower-tipping. Taxies may direct their efforts away from these neighborhoods, lowering transportation availability in them.


