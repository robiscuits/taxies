---
title: "Stat 479 Final Project"
author: "Evan O'Keefe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(RSocrata)
```

```{r}
geo_url = "https://data.cityofnewyork.us/api/geospatial/d3c5-ddgc?method=export&format=GeoJSON"

city_sf <- read_sf(geo_url, as_tibble = TRUE) %>% 
  st_transform(2263) %>% 
  select(objectid, zone, borough)

manhattan_sf <- city_sf %>% 
  filter(borough == "Manhattan")
```


```{r, fig.height=1200, fig.width=1200}
all_data <- read_csv("data/all_data.csv")

df <- all_data %>% 
  group_by(objectid) %>% 
  summarise_at(vars(trip_distance:count), sum)

rides_sf <- manhattan_sf %>% 
  merge(df)

ggplot(rides_sf) +
  geom_sf(data = manhattan_sf, fill = "white") +
  geom_sf(aes(fill = total_amount * 100)) +
  scale_fill_distiller(name = "", direction = 1, palette='Greens') +
  theme_void() +
    labs(title = 'Manhattan Yellow Taxi Revenue', subtitle = "June")

```

```{r}
library(gganimate)
library(lubridate)
library(transformr)

rides <- read_csv("data/all_data.csv") %>% 
  group_by(objectid, month) %>% 
  summarise_at(vars(trip_distance:count), sum)

rides_sf <- manhattan_sf %>% 
  merge(rides)

p <- ggplot(rides_sf, aes(group=seq_along(month))) +
  geom_sf(data = manhattan_sf, fill = "white") +
  geom_sf(aes(fill = total_amount / 1e6)) +
  scale_fill_distiller(
    name='Million $',
    breaks = c(0, 2.5, 5, 7.5, 10, 12.5, 15),
    direction = 1,
    palette='Greens',
    guide = guide_colorbar(frame.colour = "black", barwidth = 2, barheight = 30)
    ) +
  theme_void(base_size = 30) +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    title = 'Manhattan Yellow Taxi Revenue By Month',
    subtitle = '{month.name[as.integer(closest_state)]}'
    ) +
  transition_states(month) 

animate(p, height = 1200, width = 1200)
anim_save("income.gif")
```

